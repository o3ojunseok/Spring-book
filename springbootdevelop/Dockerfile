FROM eclipse-temurin:17 as builder

COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src
COPY . .


RUN chmod +x ./gradlew
RUN ./gradlew bootJar

FROM eclipse-temurin:17


#ARG ARG_SPRING_JPA_SHOW_SQL
#ARG ARG_SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL
#ARG ARG_SPRING_JPA_DEFER-DATASOURCE_INITIALIZATION
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID
ARG ARG_SPRING_DATASOURCE_URL
ARG ARG_SPRING_DATASOURCE_USERNAME
ARG ARG_SPRING_H2_CONSOLE_ENABLED
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-SECRET
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE
ARG ARG_JWT_ISSUER
ARG ARG_JWT_SECRET_KEY

ENV SPRING_JPA_SHOW_SQL=true
ENV SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=true
ENV SPRING_JPA_DEFER-DATASOURCE_INITIALIZATION=true
ENV SPRING_DATASOURCE_USERNAME=${ARG_SPRING_DATASOURCE_URL}
ENV SPRING_H2_CONSOLE_ENABLED=${ARG_SPRING_H2_CONSOLE_ENABLED}
ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID=${ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID}
ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET=${ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET}
ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE=${ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE}
ENV JWT_ISSUER=${ARG_JWT_ISSUER}
ENV JWT_SECRET_KEY=${ARG_JWT_SECRET_KEY}

COPY --from=builder build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java","-jar","/app.jar"]