FROM eclipse-temurin:17 as builder

COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src

RUN chmod +x ./gradlew
RUN ./gradlew clean bootJar
RUN ./gradlew bootJar

FROM eclipse-temurin:17


ARG ARG_SPRING_DATASOURCE_DRIVERCLASSNAME
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID
ARG ARG_SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT
ARG ARG_SPRING_DATASOURCE_URL
ARG ARG_SPRING_DATASOURCE_USERNAME
ARG ARG_SPRING_H2_CONSOLE_ENABLED
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET
ARG ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE
ARG ARG_JWT_ISSUER
ARG ARG_JWT_SECRET_KEY

ENV SPRING_JPA_SHOW_SQL=true
ENV SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=true
ENV SPRING_JPA_HIBERNATE_DDL_AUTO=create
ENV SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT=org.hibernate.dialect.H2Dialect
ENV SPRING_JPA_DEFER_DATASOURCE_INITIALIZATION=true
ENV SPRING_JPA_PROPERTIES_HIBERNATE_SHOW_SQL=true
ENV SPRING_DATASOURCE_DRIVERCLASSNAME=org.h2.Driver
ENV SPRING_H2_CONSOLE_SETTINGS_WEB_ALLOW_OTHERS=true

ENV SPRING_DATASOURCE_URL=${ARG_SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${ARG_SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${ARG_DATABASE_PASSWORD}
ENV SPRING_H2_CONSOLE_ENABLED=true

ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID=${ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID}
ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET=${ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET}
ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE=${ARG_SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_SCOPE}
ENV SPRING_DATASOURCE_DATA=classpath:data.sql
ENV JWT_ISSUER=${ARG_JWT_ISSUER}
ENV JWT_SECRET_KEY=${ARG_JWT_SECRET_KEY}

COPY --from=builder build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java","-jar","/app.jar"]